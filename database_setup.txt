
-- 1. ENABLE EXTENSIONS
create extension if not exists "uuid-ossp";

-- 2. CREATE TABLES

-- PROFILES
create table if not exists public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text,
  first_name text,
  last_name text,
  role text default 'VOTER',
  verification_status text default 'NOT_STARTED',
  is_blocked boolean default false,
  block_reason text,
  photo_url text,
  face_url text,
  age int,
  dob text,
  phone text,
  address_state text,
  address_district text,
  address_city text,
  id_number text,
  id_type text,
  kyc_doc_url text,
  
  -- NEW FIELDS
  aadhaar_number text,
  epic_number text,
  epic_doc_url text,

  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- ELECTIONS
create table if not exists public.elections (
  id text primary key,
  title text not null,
  description text,
  start_date timestamp with time zone,
  end_date timestamp with time zone,
  status text default 'UPCOMING',
  region text,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- CANDIDATES
create table if not exists public.candidates (
  id text primary key,
  election_id text references public.elections(id) on delete cascade,
  name text not null,
  party text,
  party_symbol_url text,
  photo_url text,
  manifesto text,
  votes_count int default 0,
  age int,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- VOTES
create table if not exists public.votes (
  id uuid default uuid_generate_v4() primary key,
  election_id text references public.elections(id),
  candidate_id text references public.candidates(id),
  voter_id uuid references public.profiles(id),
  block_hash text,
  risk_score float default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()),
  unique(election_id, voter_id)
);

-- REGIONS
create table if not exists public.regions (
  id text primary key,
  name text not null,
  type text,
  parent_region_id text,
  voter_count int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- FRAUD ALERTS
create table if not exists public.fraud_alerts (
  id uuid default uuid_generate_v4() primary key,
  voter_id uuid references public.profiles(id),
  election_id text references public.elections(id),
  reason text,
  risk_level text,
  details text,
  timestamp timestamp with time zone default timezone('utc'::text, now())
);

-- 3. ENABLE RLS
alter table profiles enable row level security;
alter table elections enable row level security;
alter table candidates enable row level security;
alter table votes enable row level security;
alter table regions enable row level security;
alter table fraud_alerts enable row level security;

-- 4. RLS POLICIES

-- Profiles
create policy "Public profiles are viewable by everyone" on profiles for select using (true);
create policy "Users can update own profile" on profiles for update using (auth.uid() = id);

-- Elections
create policy "Elections viewable by everyone" on elections for select using (true);
create policy "Admins insert elections" on elections for insert with check (auth.role() = 'authenticated'); 
create policy "Admins update elections" on elections for update using (auth.role() = 'authenticated');

-- Candidates
create policy "Candidates viewable by everyone" on candidates for select using (true);
create policy "Admins insert candidates" on candidates for insert with check (auth.role() = 'authenticated');
create policy "Admins delete candidates" on candidates for delete using (auth.role() = 'authenticated');
create policy "Admins update candidates" on candidates for update using (auth.role() = 'authenticated');

-- Votes
create policy "Votes viewable by everyone" on votes for select using (true);
create policy "Authenticated users can vote" on votes for insert with check (auth.role() = 'authenticated');

-- Regions
create policy "Regions viewable by everyone" on regions for select using (true);
create policy "Admins manage regions" on regions for insert with check (auth.role() = 'authenticated');

-- Fraud Alerts
create policy "Admins view alerts" on fraud_alerts for select using (true);
create policy "System inserts alerts" on fraud_alerts for insert with check (true);

-- 5. STORAGE BUCKETS
insert into storage.buckets (id, name, public) values ('uploads', 'uploads', true) ON CONFLICT DO NOTHING;
insert into storage.buckets (id, name, public) values ('faces', 'faces', true) ON CONFLICT DO NOTHING;

-- Storage Policies (Uploads)
create policy "Public Access Uploads" on storage.objects for select using ( bucket_id = 'uploads' );
create policy "Authenticated Uploads" on storage.objects for insert with check ( bucket_id = 'uploads' and auth.role() = 'authenticated' );
create policy "Anon Uploads" on storage.objects for insert with check ( bucket_id = 'uploads' );

-- Storage Policies (Faces)
create policy "Public Access Faces" on storage.objects for select using ( bucket_id = 'faces' );
create policy "Authenticated Faces" on storage.objects for insert with check ( bucket_id = 'faces' and auth.role() = 'authenticated' );
create policy "Anon Faces" on storage.objects for insert with check ( bucket_id = 'faces' );

-- 6. AUTO-PROFILE TRIGGER
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (
    id,
    email,
    first_name,
    last_name,
    role,
    age,
    dob,
    phone,
    address_state,
    address_district,
    address_city,
    id_number,
    id_type,
    kyc_doc_url,
    face_url,
    aadhaar_number,
    epic_number,
    epic_doc_url,
    photo_url
  )
  values (
    new.id,
    new.email,
    new.raw_user_meta_data->>'firstName',
    new.raw_user_meta_data->>'lastName',
    coalesce(new.raw_user_meta_data->>'role', 'VOTER'),
    (new.raw_user_meta_data->>'age')::int,
    new.raw_user_meta_data->>'dob',
    new.raw_user_meta_data->>'phone',
    new.raw_user_meta_data->>'state',
    new.raw_user_meta_data->>'district',
    new.raw_user_meta_data->>'city',
    new.raw_user_meta_data->>'idNumber',
    new.raw_user_meta_data->>'idType',
    new.raw_user_meta_data->>'kycDocUrl',
    new.raw_user_meta_data->>'faceUrl',
    new.raw_user_meta_data->>'aadhaarNumber',
    new.raw_user_meta_data->>'epicNumber',
    new.raw_user_meta_data->>'epicDocUrl',
    'https://ui-avatars.com/api/?name=' || (new.raw_user_meta_data->>'firstName') || '+' || (new.raw_user_meta_data->>'lastName') || '&background=random'
  );
  return new;
end;
$$ language plpgsql security definer;

-- Trigger
drop trigger if exists on_auth_user_created on auth.users;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- 7. REALTIME PUBLICATION
alter publication supabase_realtime add table profiles;
alter publication supabase_realtime add table elections;
alter publication supabase_realtime add table candidates;
alter publication supabase_realtime add table votes;
alter publication supabase_realtime add table regions;
alter publication supabase_realtime add table fraud_alerts;
